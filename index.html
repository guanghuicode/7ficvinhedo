<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Sorteio - Evento</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #e63946;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fb;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 10px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        input, button {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        button:hover {
            background: var(--secondary);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .scanner-container {
            text-align: center;
            margin: 20px 0;
        }
        
        #qr-video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            border: 2px solid var(--primary);
        }
        
        .hidden {
            display: none;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            border-radius: 10px;
            transition: width 0.5s;
        }
        
        .checkpoint-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .checkpoint-item {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .checkpoint-item.validado {
            border-color: var(--success);
            background: rgba(76, 201, 240, 0.1);
        }
        
        .admin-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #fca311;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Evento Sorteio</h1>
            <p>Escaneie os QR Codes nas salas para participar do sorteio</p>
        </header>
        
        <div class="card">
            <h2>Fazer Inscrição</h2>
            <form id="form-inscricao">
                <div class="form-group">
                    <label for="nome">Nome Completo</label>
                    <input type="text" id="nome" required>
                </div>
                <div class="form-group">
                    <label for="cpf">CPF (apenas números)</label>
                    <input type="text" id="cpf" required>
                </div>
                <button type="submit">Realizar Inscrição</button>
            </form>
        </div>
        
        <div class="card" id="card-login" style="display: none;">
            <h2>Já é Cadastrado?</h2>
            <form id="form-login">
                <div class="form-group">
                    <label for="cpf-login">CPF</label>
                    <input type="text" id="cpf-login" required>
                </div>
                <button type="submit" class="btn-success">Acessar Minha Conta</button>
            </form>
        </div>
        
        <div class="card" id="card-usuario" style="display: none;">
            <h2>Meu Progresso</h2>
            <div id="info-usuario"></div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="barra-progresso" style="width: 0%"></div>
                </div>
                <div id="texto-progresso">0 de 3 checkpoints validados</div>
            </div>
            
            <div class="checkpoint-list" id="lista-checkpoints">
                <!-- Checkpoints serão preenchidos aqui -->
            </div>
        </div>
        
        <div class="card">
            <h2>Escanear QR Code</h2>
            <div class="scanner-container">
                <video id="qr-video"></video>
                <div id="status-scanner">Clique em Iniciar Câmera</div>
                <button id="iniciar-camera" class="btn-success">Iniciar Câmera</button>
                <button id="parar-camera" class="btn-danger" style="display: none;">Parar Câmera</button>
            </div>
            <div id="resultado-scan" class="hidden">
                <h3>Checkpoint Validado!</h3>
                <p id="mensagem-scan"></p>
            </div>
        </div>
        
        <div class="admin-panel">
            <h3>Área do Organizador</h3>
            <div class="form-group">
                <input type="password" id="senha-admin" placeholder="Senha de administração">
                <button onclick="acessarAdmin()">Acessar</button>
            </div>
            
            <div id="painel-admin" style="display: none;">
                <button onclick="realizarSorteio()" class="btn-success">Realizar Sorteio</button>
                <div id="resultado-sorteio"></div>
                <div id="lista-participantes" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // Dados
        let participantes = JSON.parse(localStorage.getItem('participantes')) || [];
        let usuarioAtual = JSON.parse(localStorage.getItem('usuarioAtual')) || null;
        let checkpoints = [
            { id: 'checkpoint1', nome: 'Recepção' },
            { id: 'checkpoint2', nome: 'Auditório Principal' },
            { id: 'checkpoint3', nome: 'Área de Exposição' },
            { id: 'checkpoint4', nome: 'Sala de Workshop' },
            { id: 'checkpoint5', nome: 'Área de Networking' }
        ];
        
        // Elementos
        const formInscricao = document.getElementById('form-inscricao');
        const formLogin = document.getElementById('form-login');
        const cardLogin = document.getElementById('card-login');
        const cardUsuario = document.getElementById('card-usuario');
        const infoUsuario = document.getElementById('info-usuario');
        const barraProgresso = document.getElementById('barra-progresso');
        const textoProgresso = document.getElementById('texto-progresso');
        const listaCheckpoints = document.getElementById('lista-checkpoints');
        const iniciarCameraBtn = document.getElementById('iniciar-camera');
        const pararCameraBtn = document.getElementById('parar-camera');
        const video = document.getElementById('qr-video');
        const statusScanner = document.getElementById('status-scanner');
        const resultadoScan = document.getElementById('resultado-scan');
        const mensagemScan = document.getElementById('mensagem-scan');
        
        let streamVideo = null;
        let scaneando = false;
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            if (participantes.length > 0) {
                cardLogin.style.display = 'block';
            }
            
            if (usuarioAtual) {
                mostrarAreaUsuario();
            }
            
            formInscricao.addEventListener('submit', fazerInscricao);
            formLogin.addEventListener('submit', fazerLogin);
            iniciarCameraBtn.addEventListener('click', iniciarCamera);
            pararCameraBtn.addEventListener('click', pararCamera);
        });
        
        function fazerInscricao(e) {
            e.preventDefault();
            
            const nome = document.getElementById('nome').value;
            const cpf = document.getElementById('cpf').value.replace(/\D/g, '');
            
            if (cpf.length !== 11) {
                alert('CPF deve ter 11 dígitos');
                return;
            }
            
            if (participantes.find(p => p.cpf === cpf)) {
                alert('CPF já cadastrado! Faça login.');
                return;
            }
            
            const novoParticipante = {
                id: 'p_' + Date.now(),
                nome: nome,
                cpf: cpf,
                checkpoints: [],
                dataInscricao: new Date().toISOString()
            };
            
            participantes.push(novoParticipante);
            salvarDados();
            fazerLoginUsuario(novoParticipante);
            
            alert('Inscrição realizada! Agora escaneie os QR Codes nas salas.');
            formInscricao.reset();
        }
        
        function fazerLogin(e) {
            e.preventDefault();
            
            const cpf = document.getElementById('cpf-login').value.replace(/\D/g, '');
            const participante = participantes.find(p => p.cpf === cpf);
            
            if (participante) {
                fazerLoginUsuario(participante);
                alert('Login realizado!');
                formLogin.reset();
            } else {
                alert('CPF não encontrado.');
            }
        }
        
        function fazerLoginUsuario(participante) {
            usuarioAtual = participante;
            localStorage.setItem('usuarioAtual', JSON.stringify(participante));
            mostrarAreaUsuario();
        }
        
        function mostrarAreaUsuario() {
            cardLogin.style.display = 'none';
            cardUsuario.style.display = 'block';
            atualizarProgresso();
        }
        
        function atualizarProgresso() {
            infoUsuario.innerHTML = `<h3>Olá, ${usuarioAtual.nome}!</h3><p>CPF: ${formatarCPF(usuarioAtual.cpf)}</p>`;
            
            const checkpointsValidados = usuarioAtual.checkpoints.length;
            const porcentagem = Math.min((checkpointsValidados / 3) * 100, 100);
            
            barraProgresso.style.width = porcentagem + '%';
            textoProgresso.textContent = `${checkpointsValidados} de 3 checkpoints validados`;
            
            // Lista de checkpoints
            listaCheckpoints.innerHTML = '';
            checkpoints.forEach(checkpoint => {
                const isValidado = usuarioAtual.checkpoints.includes(checkpoint.id);
                const item = document.createElement('div');
                item.className = `checkpoint-item ${isValidado ? 'validado' : ''}`;
                item.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 10px;">${isValidado ? '✅' : '📍'}</div>
                    <div><strong>${checkpoint.nome}</strong></div>
                    <div style="font-size: 12px; color: ${isValidado ? 'green' : 'orange'}">
                        ${isValidado ? 'Validado' : 'Pendente'}
                    </div>
                `;
                listaCheckpoints.appendChild(item);
            });
        }
        
        function formatarCPF(cpf) {
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        }
        
        // Scanner de QR Code
        function iniciarCamera() {
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            }).then(stream => {
                streamVideo = stream;
                video.srcObject = stream;
                video.play();
                scaneando = true;
                escanear();
                
                iniciarCameraBtn.style.display = 'none';
                pararCameraBtn.style.display = 'block';
                statusScanner.textContent = 'Posicione o QR Code na câmera';
            }).catch(err => {
                statusScanner.textContent = 'Erro ao acessar câmera: ' + err.message;
            });
        }
        
        function pararCamera() {
            if (streamVideo) {
                streamVideo.getTracks().forEach(track => track.stop());
            }
            scaneando = false;
            iniciarCameraBtn.style.display = 'block';
            pararCameraBtn.style.display = 'none';
            resultadoScan.classList.add('hidden');
        }
        
        function escanear() {
            if (!scaneando) return;
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    validarCheckpoint(code.data);
                }
            }
            
            requestAnimationFrame(escanear);
        }
        
        function validarCheckpoint(idCheckpoint) {
            const checkpoint = checkpoints.find(cp => cp.id === idCheckpoint);
            
            if (!checkpoint) {
                statusScanner.textContent = 'QR Code inválido';
                return;
            }
            
            if (usuarioAtual.checkpoints.includes(idCheckpoint)) {
                statusScanner.textContent = `Você já validou ${checkpoint.nome}`;
            } else {
                usuarioAtual.checkpoints.push(idCheckpoint);
                
                // Atualizar nos dados
                const index = participantes.findIndex(p => p.id === usuarioAtual.id);
                if (index !== -1) {
                    participantes[index] = usuarioAtual;
                    salvarDados();
                    localStorage.setItem('usuarioAtual', JSON.stringify(usuarioAtual));
                }
                
                mensagemScan.textContent = `Checkpoint "${checkpoint.nome}" validado com sucesso!`;
                resultadoScan.classList.remove('hidden');
                atualizarProgresso();
                
                setTimeout(() => {
                    resultadoScan.classList.add('hidden');
                }, 3000);
            }
            
            pararCamera();
        }
        
        // Administração
        function acessarAdmin() {
            const senha = document.getElementById('senha-admin').value;
            if (senha === 'admin123') {
                document.getElementById('painel-admin').style.display = 'block';
                atualizarListaParticipantes();
            } else {
                alert('Senha incorreta');
            }
        }
        
        function atualizarListaParticipantes() {
            const lista = document.getElementById('lista-participantes');
            lista.innerHTML = '<h4>Participantes:</h4>';
            
            participantes.forEach(p => {
                const qualificado = p.checkpoints.length >= 3;
                const div = document.createElement('div');
                div.style.padding = '10px';
                div.style.borderBottom = '1px solid #eee';
                div.innerHTML = `
                    <strong>${p.nome}</strong> - ${formatarCPF(p.cpf)}
                    <br>Checkpoints: ${p.checkpoints.length}/3
                    <span style="color: ${qualificado ? 'green' : 'orange'}; margin-left: 10px;">
                        ${qualificado ? '✓ Qualificado' : 'Não qualificado'}
                    </span>
                    <button onclick="removerParticipante('${p.id}')" style="margin-left: 10px; padding: 2px 8px; background: #e63946; color: white; border: none; border-radius: 3px; font-size: 12px;">Remover</button>
                `;
                lista.appendChild(div);
            });
        }
        
        function removerParticipante(id) {
            if (confirm('Tem certeza que deseja remover este participante?')) {
                participantes = participantes.filter(p => p.id !== id);
                salvarDados();
                atualizarListaParticipantes();
                
                if (usuarioAtual && usuarioAtual.id === id) {
                    usuarioAtual = null;
                    localStorage.removeItem('usuarioAtual');
                    location.reload();
                }
            }
        }
        
        function realizarSorteio() {
            const qualificados = participantes.filter(p => p.checkpoints.length >= 3);
            
            if (qualificados.length === 0) {
                alert('Nenhum participante qualificado para o sorteio');
                return;
            }
            
            const vencedor = qualificados[Math.floor(Math.random() * qualificados.length)];
            document.getElementById('resultado-sorteio').innerHTML = `
                <div style="background: #4cc9f0; color: white; padding: 20px; border-radius: 10px; margin-top: 10px; text-align: center;">
                    <h3>🎉 Parabéns ao Vencedor! 🎉</h3>
                    <p><strong>${vencedor.nome}</strong></p>
                    <p>CPF: ${formatarCPF(vencedor.cpf)}</p>
                </div>
            `;
        }
        
        function salvarDados() {
            localStorage.setItem('participantes', JSON.stringify(participantes));
        }
    </script>
</body>
</html>